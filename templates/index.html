<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Causewise RCA Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Removed external CDN for security - using vanilla JavaScript instead -->
</head>
<body>
    <h1>Causewise: LLM-Powered RCA Assistant</h1>
    
    <!-- System Monitoring Dashboard -->
    <div class="monitoring-section">
        <h3>üìä System Monitoring</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h4>CPU Usage</h4>
                <div class="progress-bar">
                    <div class="progress-fill cpu" style="width: {{ system_stats.cpu_percent|e }}%"></div>
                </div>
                <span>{{ system_stats.cpu_percent|e }}%</span>
            </div>
            <div class="stat-card">
                <h4>Memory Usage</h4>
                <div class="progress-bar">
                    <div class="progress-fill memory" style="width: {{ system_stats.memory_percent|e }}%"></div>
                </div>
                <span>{{ system_stats.memory_used_mb|e }}MB / {{ system_stats.memory_total_mb|e }}MB ({{ system_stats.memory_percent|e }}%)</span>
            </div>
            <div class="stat-card">
                <h4>Process Info</h4>
                <div class="process-info">
                    <span>PID: {{ process_info.pid|e }}</span>
                    <span>Threads: {{ process_info.threads|e }}</span>
                    <span>Memory: {{ process_info.memory_mb|e }}MB</span>
                </div>
            </div>
        </div>
        <div class="validation-section">
            <button id="validate-llm" class="validate-btn">üîç Test LLM Connection</button>
            <div id="validation-result" class="validation-result"></div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div id="progress-section" class="progress-section" style="display: none;">
        <h3>‚è≥ Processing Status</h3>
        <div class="progress-container">
            <div class="progress-bar large">
                <div id="progress-fill" class="progress-fill processing" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="progress-text">Ready</div>
        </div>
    </div>
    
    <div class="upload-section">
        <h3>Upload Incident Log</h3>
        <form action="/analyze" method="post" enctype="multipart/form-data" onsubmit="startProgress()">
            <input type="file" name="incident_file" accept=".log,.txt,.json,.csv" required>
            <button type="submit">Analyze File</button>
        </form>
    </div>
    
    <div class="demo-section">
        <h3>Try Demo - Enterprise Log Formats</h3>
        <p>Test the application with different types of enterprise log data:</p>
        <div class="demo-buttons">
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_basic" value="true" class="demo-btn basic">Basic Log Format</button>
            </form>
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_splunk" value="true" class="demo-btn splunk">Splunk JSON</button>
            </form>
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_complex" value="true" class="demo-btn complex">Complex System Log</button>
            </form>
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_cisco" value="true" class="demo-btn cisco">Cisco Network Log</button>
            </form>
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_polycom" value="true" class="demo-btn polycom">Polycom VoIP Log</button>
            </form>
        </div>
        <div class="supported-formats">
            <h4>üìÅ Supported Enterprise Formats:</h4>
            <ul>
                <li><strong>.log, .txt</strong> - Plain text logs with intelligent parsing</li>
                <li><strong>.json</strong> - Splunk exports and structured JSON logs</li>
                <li><strong>.csv</strong> - Comma-separated log data</li>
                <li><strong>Cisco IOS</strong> - Network device logs with facility codes</li>
                <li><strong>Polycom VoIP</strong> - Voice communication system logs</li>
                <li><strong>Auto-detection</strong> - Smart format recognition</li>
            </ul>
        </div>
    </div>
    
    {% if error %}
        <div class="error-section">
            <h2>‚ùå Error</h2>
            <pre class="error-message">{{ error|e }}</pre>
        </div>
    {% endif %}
    
    {% if raw_log_data or analysis %}
        <div class="results-section">
            {% if demo_type %}
                <div class="demo-info">
                    <h3>üìä Demo Type: {{ demo_type|e }}</h3>
                </div>
            {% endif %}
            
            {% if raw_log_data %}
                <div class="before-section">
                    <h2>üìã Raw Log Data (Before AI Analysis)</h2>
                    <pre class="raw-log">{{ raw_log_data|e }}</pre>
                </div>
            {% endif %}
            
            {% if analysis %}
                <div class="after-section">
                    <h2>üîç AI-Powered Root Cause Analysis (After Processing)</h2>
                    <pre class="analysis-result">{{ analysis|e }}</pre>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <script>
        let progressInterval;
        
        function startProgress() {
            document.getElementById('progress-section').style.display = 'block';
            progressInterval = setInterval(updateProgress, 500);
        }
        
        function updateProgress() {
            fetch('/progress')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('progress-fill').style.width = data.percent + '%';
                    document.getElementById('progress-text').textContent = data.message;
                    
                    if (!data.processing) {
                        clearInterval(progressInterval);
                        setTimeout(() => {
                            document.getElementById('progress-section').style.display = 'none';
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Progress update error:', error);
                    clearInterval(progressInterval);
                });
        }
        
        // Auto-refresh system stats every 5 seconds
        setInterval(() => {
            fetch('/system_stats')
                .then(response => response.json())
                .then(data => {
                    // Update CPU usage
                    document.querySelector('.progress-fill.cpu').style.width = data.system.cpu_percent + '%';
                    document.querySelector('.stat-card:nth-child(1) span').textContent = data.system.cpu_percent + '%';
                    
                    // Update Memory usage
                    document.querySelector('.progress-fill.memory').style.width = data.system.memory_percent + '%';
                    document.querySelector('.stat-card:nth-child(2) span').textContent = 
                        data.system.memory_used_mb + 'MB / ' + data.system.memory_total_mb + 'MB (' + data.system.memory_percent + '%)';
                    
                    // Update Process info
                    document.querySelector('.process-info').innerHTML = 
                        '<span>PID: ' + data.process.pid + '</span>' +
                        '<span>Threads: ' + data.process.threads + '</span>' +
                        '<span>Memory: ' + data.process.memory_mb + 'MB</span>';
                })
                .catch(error => console.error('Stats update error:', error));
        }, 5000);
        
        // LLM Validation
        document.getElementById('validate-llm').addEventListener('click', function() {
            this.disabled = true;
            this.textContent = 'üîÑ Testing...';
            
            fetch('/validate_llm')
                .then(response => response.json())
                .then(data => {
                    const resultDiv = document.getElementById('validation-result');
                    if (data.validation_passed) {
                        resultDiv.innerHTML = '';
                        const successDiv = document.createElement('div');
                        successDiv.className = 'validation-success';
                        successDiv.innerHTML = '‚úÖ LLM Connection Successful<br>Model: ' +
                            escapeHtml(data.model) + '<br>Response Time: ' +
                            escapeHtml(data.response_time_ms) + 'ms<br>Timestamp: ' +
                            escapeHtml(data.timestamp);
                        resultDiv.appendChild(successDiv);
                    } else {
                        resultDiv.innerHTML = '';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'validation-error';
                        errorDiv.innerHTML = '‚ùå LLM Connection Failed<br>Error: ' +
                            escapeHtml(data.error || 'Unknown error') + '<br>Timestamp: ' +
                            escapeHtml(data.timestamp);
                        resultDiv.appendChild(errorDiv);
                    }
                    
                    this.disabled = false;
                    this.textContent = 'üîç Test LLM Connection';
                })
                .catch(error => {
                    const resultDiv = document.getElementById('validation-result');
                    resultDiv.innerHTML = '';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'validation-error';
                    errorDiv.innerHTML = '‚ùå Request Failed: ' + escapeHtml(error.message);
                    resultDiv.appendChild(errorDiv);
                    this.disabled = false;
                    this.textContent = 'üîç Test LLM Connection';
                });
        });
        
        // XSS Protection: HTML escape function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>