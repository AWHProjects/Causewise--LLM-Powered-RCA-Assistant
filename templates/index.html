<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Causewise RCA Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Causewise: LLM-Powered RCA Assistant</h1>
    
    <!-- System Monitoring Dashboard -->
    <div class="monitoring-section">
        <h3>üìä System Monitoring</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h4>CPU Usage</h4>
                <div class="progress-bar">
                    <div class="progress-fill cpu" style="width: {{ system_stats.cpu_percent }}%"></div>
                </div>
                <span>{{ system_stats.cpu_percent }}%</span>
            </div>
            <div class="stat-card">
                <h4>Memory Usage</h4>
                <div class="progress-bar">
                    <div class="progress-fill memory" style="width: {{ system_stats.memory_percent }}%"></div>
                </div>
                <span>{{ system_stats.memory_used_mb }}MB / {{ system_stats.memory_total_mb }}MB ({{ system_stats.memory_percent }}%)</span>
            </div>
            <div class="stat-card">
                <h4>Process Info</h4>
                <div class="process-info">
                    <span>PID: {{ process_info.pid }}</span>
                    <span>Threads: {{ process_info.threads }}</span>
                    <span>Memory: {{ process_info.memory_mb }}MB</span>
                </div>
            </div>
        </div>
        <div class="validation-section">
            <button id="validate-llm" class="validate-btn">üîç Test LLM Connection</button>
            <div id="validation-result" class="validation-result"></div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div id="progress-section" class="progress-section" style="display: none;">
        <h3>‚è≥ Processing Status</h3>
        <div class="progress-container">
            <div class="progress-bar large">
                <div id="progress-fill" class="progress-fill processing" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="progress-text">Ready</div>
        </div>
    </div>
    
    <div class="upload-section">
        <h3>Upload Incident Log</h3>
        <form action="/analyze" method="post" enctype="multipart/form-data" onsubmit="startProgress()">
            <input type="file" name="incident_file" accept=".log,.txt,.json,.csv" required>
            <button type="submit">Analyze File</button>
        </form>
    </div>
    
    <div class="demo-section">
        <h3>Try Demo - Enterprise Log Formats</h3>
        <p>Test the application with different types of enterprise log data:</p>
        <div class="demo-buttons">
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_basic" value="true" class="demo-btn basic">Basic Log Format</button>
            </form>
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_splunk" value="true" class="demo-btn splunk">Splunk JSON</button>
            </form>
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_complex" value="true" class="demo-btn complex">Complex System Log</button>
            </form>
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_cisco" value="true" class="demo-btn cisco">Cisco Network Log</button>
            </form>
            <form action="/analyze" method="post" style="display: inline;" onsubmit="startProgress()">
                <button type="submit" name="demo_polycom" value="true" class="demo-btn polycom">Polycom VoIP Log</button>
            </form>
        </div>
        <div class="supported-formats">
            <h4>üìÅ Supported Enterprise Formats:</h4>
            <ul>
                <li><strong>.log, .txt</strong> - Plain text logs with intelligent parsing</li>
                <li><strong>.json</strong> - Splunk exports and structured JSON logs</li>
                <li><strong>.csv</strong> - Comma-separated log data</li>
                <li><strong>Cisco IOS</strong> - Network device logs with facility codes</li>
                <li><strong>Polycom VoIP</strong> - Voice communication system logs</li>
                <li><strong>Auto-detection</strong> - Smart format recognition</li>
            </ul>
        </div>
    </div>
    
    {% if error %}
        <div class="error-section">
            <h2>‚ùå Error</h2>
            <pre class="error-message">{{ error }}</pre>
        </div>
    {% endif %}
    
    {% if raw_log_data or analysis %}
        <div class="results-section">
            {% if demo_type %}
                <div class="demo-info">
                    <h3>üìä Demo Type: {{ demo_type }}</h3>
                </div>
            {% endif %}
            
            {% if raw_log_data %}
                <div class="before-section">
                    <h2>üìã Raw Log Data (Before AI Analysis)</h2>
                    <pre class="raw-log">{{ raw_log_data }}</pre>
                </div>
            {% endif %}
            
            {% if analysis %}
                <div class="after-section">
                    <h2>üîç AI-Powered Root Cause Analysis (After Processing)</h2>
                    <pre class="analysis-result">{{ analysis }}</pre>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <script>
        let progressInterval;
        
        function startProgress() {
            document.getElementById('progress-section').style.display = 'block';
            progressInterval = setInterval(updateProgress, 500);
        }
        
        function updateProgress() {
            fetch('/progress')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('progress-fill').style.width = data.percent + '%';
                    document.getElementById('progress-text').textContent = data.message;
                    
                    if (!data.processing) {
                        clearInterval(progressInterval);
                        setTimeout(() => {
                            document.getElementById('progress-section').style.display = 'none';
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Progress update error:', error);
                    clearInterval(progressInterval);
                });
        }
        
        // Auto-refresh system stats every 5 seconds
        setInterval(() => {
            fetch('/system_stats')
                .then(response => response.json())
                .then(data => {
                    // Update CPU usage
                    document.querySelector('.progress-fill.cpu').style.width = data.system.cpu_percent + '%';
                    document.querySelector('.stat-card:nth-child(1) span').textContent = data.system.cpu_percent + '%';
                    
                    // Update Memory usage
                    document.querySelector('.progress-fill.memory').style.width = data.system.memory_percent + '%';
                    document.querySelector('.stat-card:nth-child(2) span').textContent = 
                        data.system.memory_used_mb + 'MB / ' + data.system.memory_total_mb + 'MB (' + data.system.memory_percent + '%)';
                    
                    // Update Process info
                    document.querySelector('.process-info').innerHTML = 
                        '<span>PID: ' + data.process.pid + '</span>' +
                        '<span>Threads: ' + data.process.threads + '</span>' +
                        '<span>Memory: ' + data.process.memory_mb + 'MB</span>';
                })
                .catch(error => console.error('Stats update error:', error));
        }, 5000);
        
        // LLM Validation
        document.getElementById('validate-llm').addEventListener('click', function() {
            this.disabled = true;
            this.textContent = 'üîÑ Testing...';
            
            fetch('/validate_llm')
                .then(response => response.json())
                .then(data => {
                    const resultDiv = document.getElementById('validation-result');
                    if (data.validation_passed) {
                        resultDiv.innerHTML = `
                            <div class="validation-success">
                                ‚úÖ LLM Connection Successful<br>
                                Model: ${data.model}<br>
                                Response Time: ${data.response_time_ms}ms<br>
                                Timestamp: ${data.timestamp}
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="validation-error">
                                ‚ùå LLM Connection Failed<br>
                                Error: ${data.error || 'Unknown error'}<br>
                                Timestamp: ${data.timestamp}
                            </div>
                        `;
                    }
                    
                    this.disabled = false;
                    this.textContent = 'üîç Test LLM Connection';
                })
                .catch(error => {
                    document.getElementById('validation-result').innerHTML = `
                        <div class="validation-error">
                            ‚ùå Request Failed: ${error.message}
                        </div>
                    `;
                    this.disabled = false;
                    this.textContent = 'üîç Test LLM Connection';
                });
        });
    </script>
</body>
</html>